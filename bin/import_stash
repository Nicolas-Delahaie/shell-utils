#!/bin/bash
# Import a stash from an exported directory

set -eu

stash_dir="${1:-}"

if [[ -z "$stash_dir" ]]; then
    echo "Usage: import_stash <stash_dir>" >&2
    exit 1
fi

patch_file="$stash_dir/stash.patch"
metadata_file="$stash_dir/metadata.txt"

echo -n "Checking stash export..."
if [[ ! -d "$stash_dir" ]]; then
    echo -e "\nError: $stash_dir is not a directory" >&2
    exit 1
fi
if [[ ! -f "$metadata_file" ]]; then
    echo -e "\nError: $metadata_file not found" >&2
    exit 1
fi
if [[ ! -f "$patch_file" ]]; then
    echo -e "\nError: $patch_file not found" >&2
    exit 1
fi
echo "done"

echo -n "Reading stash metadata..."
source "$metadata_file"
echo "done"

echo -n "Checking if commit exists..."
if ! git rev-parse "$base_commit" 2>/dev/null; then
    echo -e "\nError: Commit $base_commit not found" >&2
    exit 1
fi
echo "done"

echo -n "Switching to $base_commit..."
original_ref=$(git rev-parse --abbrev-ref HEAD)
git switch --detach "$base_commit" -q
echo "done"

echo -n "Applying stash patch..."
git apply "$patch_file" || {
    echo -e "\nError: Could not apply patch cleanly" >&2
    echo -n "Returning to $original_ref..."
    git switch "$original_ref" -q
    exit 1
}
echo "done"

echo -n "Creating stash..."
git stash push -uq -m "$stash_message"
echo "done"

echo -n "Returning to $original_ref..."
git switch "$original_ref" -q
echo "done"

echo -n "Delete stash directory? (y/n) "
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
    echo -n "Deleting stash directory..."
    rm -rf "$stash_dir"
    echo "done"
fi

echo "Stash imported successfully: $stash_message"
