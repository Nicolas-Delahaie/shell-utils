#!/bin/bash
set -e

DEFAULT_DELAY=60
ALERT_TIME=1000
OUTPUT_FILE_PATH="."

DELAY=${2:-$DEFAULT_DELAY}
TARGET=${1:-}
if [ -z "$TARGET" ]; then
    echo "Usage: target is missing (Hostname or IP address)"
    exit 1
fi

LOG_FILE="${OUTPUT_FILE_PATH}/ping_log_${TARGET}.txt"
echo "Pings vers $TARGET toutes les $DELAY secondes"> "$LOG_FILE"

if [[ "$(uname -s)" == "MINGW"* ]]; then
    # Git Bash (Windows)
    PING_CMD="ping -n 1 $TARGET"
else
    # WSL ou Linux
    PING_CMD="ping -c 1 $TARGET"
fi

while true; do
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    if PING_OUTPUT=$($PING_CMD); then
        if [[ $PING_OUTPUT =~ time[[:space:]]([0-9]+)ms ]]; then
            DURATION=${BASH_REMATCH[1]}
        else
            echo "Unexpected ping output: $PING_OUTPUT"
            exit 1
        fi

        if (( DURATION < ALERT_TIME )); then
            echo "$timestamp - Normal ping (${DURATION} ms)" >> $LOG_FILE
        else
            echo "$timestamp - Long ping (${DURATION} ms)" >> $LOG_FILE
        fi
    else
        echo "$timestamp - Failed ping" >> $LOG_FILE
    fi

    sleep $DELAY
done
