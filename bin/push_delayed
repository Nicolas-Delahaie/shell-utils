#!/bin/bash
# Push the next commit, modifying its date to the next day

set -eu

# On macOS, use gnubin
if [[ "$(uname)" == "Darwin" ]]; then
    export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH"
fi

# -j days to jump (next day interval)
next_day_interval=1
# -g generate random time in the day
random_enabled=false
# -n number of commits to push
commit_count=1
# -i for interractive mode, which waits for a confirmation
interactive=false

while getopts "igj:n:" opt; do
    case $opt in
        i)
            interactive=true
            ;;
        g)
            random_enabled=true
            echo "Random date generation enabled."
            ;;
        j)
            next_day_interval="$OPTARG"
            echo "Next day interval set to $next_day_interval."
            if ((next_day_interval < 1)); then
                echo "Error: Next day interval must be at least 1."
                exit 1
            fi
            ;;
        n)
            commit_count="$OPTARG"
            echo "Commit count set to $commit_count."
            if ((commit_count < 1)); then
                echo "Error: Commit count must be at least 1."
                exit 1
            fi
            ;;
        \?)
            exit 1
            ;;
        :)
            exit 1
            ;;
    esac
done

TMP_BRANCH="tmp-delay"
branch_name=$(git rev-parse --abbrev-ref HEAD)

# CHECKS. 
echo -n "Checking if ${TMP_BRANCH} already exists..."
if git show-ref --verify --quiet refs/heads/${TMP_BRANCH}; then
    echo -e "\nError: Temporary branch ${TMP_BRANCH} already exists. Please delete it before running this script." >&2
    exit 1
fi
echo "done"

echo -n "Checking if branch exists on origin..."
if ! git show-ref --verify --quiet refs/remotes/origin/${branch_name}; then
    echo -e "\nError: Branch ${branch_name} does not exist on origin" >&2
    exit 1
fi
echo "done"

# Get commits to push
echo -n "Searching commits to push..."
commits=($(git rev-list origin/${branch_name}..${branch_name} --reverse | head -n ${commit_count}))
if (( ${#commits[@]} == 0 )); then
    echo -e "\nError: No commits to push on ${branch_name}" >&2
    exit 1
fi
if (( ${#commits[@]} != commit_count )); then
    echo -e "\nError: Requested ${commit_count} commits, but only ${#commits[@]} are available to push on ${branch_name}" >&2
    exit 1
fi
echo "done"

# Dates generation
latest_pushed_date=$(git show -s --format=%cI "origin/${branch_name}")
new_day=$(date -d "$latest_pushed_date + ${next_day_interval} day" +%Y-%m-%d)
time_format="%H:%M:%S%z"
format="+%Y-%m-%d $time_format"
new_dates=()
if $random_enabled; then
    for _ in $(seq 1 $commit_count); do
        H=$((RANDOM % 24))
        M=$((RANDOM % 60))
        S=$((RANDOM % 60))

        new_dates+=("$(date -d "$new_day ${H}:${M}:${S}" $format)")
    done
else
    # Existing time extraction
    for c in "${commits[@]}"; do
        date=$(git show -s --format=%aI "$c")
        time_part=$(date -d "$date" +%H:%M:%S%z)
        new_dates+=("$(date -d "$new_day $time_part" "$format")")
    done
fi

# Re organizing commit dates
IFS=$'\n' sorted_new_dates=($(printf '%s\n' "${new_dates[@]}" | sort))
unset IFS

# Transform to string for export
printf -v dates_str '%s|' "${sorted_new_dates[@]}"
dates_str="${dates_str%|}"

# Start processing
last_idx=$((commit_count - 1))
latest_commit="${commits[$last_idx]}"
echo -n "Switching to latest commit to push..."
git switch -qc ${TMP_BRANCH} ${latest_commit}
echo "done"

# Rebase
# Needs an export for the git rebase --exec to access it
export dates_str
git rebase origin/${branch_name} --exec \
'n=$(cat .git/rebase-merge/msgnum); idx=$((n/2)); date=$(echo "$dates_str" | cut -d"|" -f$idx); GIT_COMMITTER_DATE="$date" git commit --amend --no-edit --date="$date"' >/dev/null

echo -n "Returning to ${branch_name}..."
git switch ${branch_name} -q
echo "done"

if $interactive; then
    echo "Branch ${TMP_BRANCH} will be pushed to remote ${branch_name}. Continue ? (y/n)"
    read -r response
    if [[ "$response" != "y" && "$response" != "Y" ]]; then
        echo "Operation cancelled by user."
        echo -n "Deleting temporary branch ${TMP_BRANCH}..."
        git branch -qD ${TMP_BRANCH}
        echo "done"
        exit 0
    fi
fi

echo -n "Rebasing ${TMP_BRANCH} onto ${branch_name}..."
git -c advice.skippedCherryPicks=false rebase ${TMP_BRANCH} -q
echo "done"

echo -n "Pushing ${TMP_BRANCH} to remote ${branch_name}..."
git push origin ${TMP_BRANCH}:${branch_name} -q
echo "done"

echo -n "Deleting temporary branch ${TMP_BRANCH}..."
git branch -qd ${TMP_BRANCH}
echo "done"

echo "Pushed delayed commit to remote ${branch_name} successfully"