#!/bin/bash
# Export a stash to a directory for later import

set -eu

stash_num=0
while getopts "s:d:" opt; do
    case $opt in
        s)
            stash_num="$OPTARG"
            ;;
        d)
            dest="$OPTARG"
            ;;
        \?)
            echo "Usage: export_stash [-s <stash_num>] [-d <dest>]" >&2
            exit 1
            ;;
        :)
            echo "Usage: export_stash [-s <stash_num>] [-d <dest>]" >&2
            exit 1
            ;;
    esac
done

timestamp=$(date +"%Y%m%d_%H%M%S")
dir_name="stash_${stash_num}_${timestamp}"
export_dir="./$dir_name"

echo -n "Checking stash@{$stash_num} exists..."
if ! git stash list | grep -q "stash@{$stash_num}"; then
    echo -e "\nError: stash@{$stash_num} not found" >&2
    exit 1
fi
echo "done"

echo -n "Creating output directory ($export_dir)..."
if [[ -e "$export_dir" ]]; then
    echo -e "\nError: $export_dir already exists" >&2
    exit 1
fi
mkdir -p "$export_dir"
echo "done"

# Extract stash information
stash_message=$(git stash list | sed -n "$((stash_num + 1))p" | sed 's/^stash@{[0-9]*}: //')
stash_hash=$(git rev-parse "stash@{$stash_num}")
base_commit=$(git rev-parse "stash@{$stash_num}^")

echo -n "Exporting stash metadata..."
cat > "$export_dir/metadata.txt" <<EOF
stash_message="$stash_message"
stash_hash="$stash_hash"
base_commit="$base_commit"
export_date="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
EOF
echo "done"

echo -n "Exporting stash patch..."
git diff "stash@{$stash_num}^..stash@{$stash_num}" > "$export_dir/stash.patch"
echo "done"

if [[ -z "${dest:-}" ]]; then
    echo "Stash created successfully to : $export_dir"
else
    echo -n "Copying stash directory to $dest..."
    scp -r "$export_dir" "$dest" >/dev/null
    rm -rf "$export_dir"
    echo "done"

    echo "Stash exported successfully to: $dest/$dir_name"
fi

echo -n "Delete stash@{$stash_num}? (y/N): "
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
    echo -n "Dropping stash@{$stash_num}..."
    git stash drop "stash@{$stash_num}" -q
    echo "done"
fi
