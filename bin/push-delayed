#!/bin/bash
# Push the next commit, modifying its date to the next day

set -eu

# -j days to jump (next day interval)
next_day_interval=1
# -g generate random time in the day
random_enabled=false
# -n number of commits to push
commit_count=1

while getopts "gj:n:" opt; do
    case $opt in
        g)
            random_enabled=true
            echo "Random date generation enabled."
            ;;
        j)
            next_day_interval="$OPTARG"
            echo "Next day interval set to $next_day_interval."
            if ((next_day_interval < 1)); then
                echo "Error: Next day interval must be at least 1."
                exit 1
            fi
            ;;
        n)
            commit_count="$OPTARG"
            echo "Commit count set to $commit_count."
            if ((commit_count < 1)); then
                echo "Error: Commit count must be at least 1."
                exit 1
            fi
            ;;
        \?)
            exit 1
            ;;
        :)
            exit 1
            ;;
    esac
done

TMP_BRANCH="tmp-delay"
branch_name=$(git rev-parse --abbrev-ref HEAD)

# CHECKS. 
echo -n "Checking if ${TMP_BRANCH} already exists..."
if git show-ref --verify --quiet refs/heads/${TMP_BRANCH}; then
    echo -e "\nError: Temporary branch ${TMP_BRANCH} already exists. Please delete it before running this script." >&2
    exit 1
fi
echo "done"

echo -n "Checking if branch exists on origin..."
if ! git show-ref --verify --quiet refs/remotes/origin/${branch_name}; then
    echo -e "\nError: Branch ${branch_name} does not exist on origin" >&2
    exit 1
fi
echo "done"

# Get commits to push
echo -n "Searching commits to push..."
commits=($(git rev-list origin/${branch_name}..${branch_name} --reverse | head -n ${commit_count}))
if (( ${#commits[@]} == 0 )); then
    echo -e "\nError: No commits to push on ${branch_name}" >&2
    exit 1
fi
if (( ${#commits[@]} != commit_count )); then
    echo -e "\nError: Requested ${commit_count} commits, but only ${#commits[@]} are available to push on ${branch_name}" >&2
    exit 1
fi
echo "done"

# Date edition
latest_pushed_date=$(git show -s --format=%cI "origin/${branch_name}")
new_date=$(date -d "$latest_pushed_date + ${next_day_interval} day" +%Y-%m-%d)
new_dates=()
if $random_enabled; then
    for _ in $(seq 1 $commit_count); do
        random_hour=$((RANDOM % 24))
        random_minute=$((RANDOM % 60))
        random_second=$((RANDOM % 60))

        new_time=$(printf "%02d:%02d:%02d" $random_hour $random_minute $random_second)
        new_dates+=("$(date -d "$new_date $new_time" "+%Y-%m-%d %H:%M:%S%z")")
    done
else
    # Existing time extraction
    for c in "${commits[@]}"; do
        latest_pushed_date=$(git show -s --format=%aI "$c")
        time_part=$(date -d "$latest_pushed_date" +%H:%M:%S%z)
        new_dates+=("$(date -d "$new_date $time_part" "+%Y-%m-%d %H:%M:%S%z")")
    done
fi

# Re organizing commit dates
IFS=$'\n' sorted_new_dates=($(printf '%s\n' "${new_dates[@]}" | sort))
unset IFS

printf -v dates_str '%s|' "${sorted_new_dates[@]}"
# Needs an export for the git rebase --exec to access it
export dates_str="${dates_str%|}"

# Start processing
latest_commit="${commits[-1]}"
echo -n "Switching to latest commit to push..."
git switch -qc ${TMP_BRANCH} ${latest_commit}
echo "done"

git rebase origin/${branch_name} --exec \
'n=$(cat .git/rebase-merge/msgnum); idx=$((n/2)); date=$(echo "$dates_str" | cut -d"|" -f$idx); GIT_COMMITTER_DATE="$date" git commit --amend --no-edit --date="$date"' >/dev/null

echo -n "Returning to ${branch_name}..."
git switch ${branch_name} -q
echo "done"

echo "Are you sure you want to push ${commit_count} commits to remote ${branch_name} with modified dates? (y/n)"
read -r response
if [[ "$response" != "y" && "$response" != "Y" ]]; then
    echo "Operation cancelled by user."
    echo -n "Deleting temporary branch ${TMP_BRANCH}..."
    git branch -qD ${TMP_BRANCH}
    echo "done"
    exit 0
fi

echo -n "Rebasing ${TMP_BRANCH} onto ${branch_name}..."
git -c advice.skippedCherryPicks=false rebase ${TMP_BRANCH} -q
echo "done"

echo -n "Pushing ${TMP_BRANCH} to remote ${branch_name}..."
git push origin ${TMP_BRANCH}:${branch_name} -q
echo "done"

echo -n "Deleting temporary branch ${TMP_BRANCH}..."
git branch -qd ${TMP_BRANCH}
echo "done"

echo "Pushed delayed commit to remote ${branch_name} successfully"