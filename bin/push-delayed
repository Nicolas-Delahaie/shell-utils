#!/bin/bash
# Push the next commit, modifying its date to the next day

set -euo pipefail

# -j days to jump (next day interval)
next_day_interval=1
# -g generate random time in the day
random_enabled=false

while getopts "gj:" opt; do
    case $opt in
        g)
            random_enabled=true
            echo "Random date generation enabled."
            ;;
        j)
            next_day_interval="$OPTARG"
            echo "Next day interval set to $next_day_interval."
            if ((next_day_interval < 1)); then
                echo "Error: Next day interval must be at least 1."
                exit 1
            fi
            ;;
        \?)
            exit 1
            ;;
        :)
            exit 1
            ;;
    esac
done

branch_name=$(git rev-parse --abbrev-ref HEAD)

git switch -qc tmp-delay origin/${branch_name} 
target_commit=$(git log ..${branch_name} --reverse --format="%H" | head -1)
git merge $target_commit --ff-only -q

previous_commit_date=$(git log -2 --pretty=format:"%cd" --date=iso | tail -1)
next_day=$(date -d "$previous_commit_date + $next_day_interval day" +"%Y-%m-%d")

# Date edition
if $random_enabled; then
    if ((RANDOM % 2 == 0)); then
        base_time="$next_day 00:00:00"
        max_seconds=$((2 * 3600))
    else
        base_time="$next_day 18:00:00"
        max_seconds=$((6 * 3600))
    fi
    random_seconds=$((RANDOM % max_seconds))
    D=$(date -d "$base_time $random_seconds seconds" --iso-8601=seconds)
else
    current_commit_date=$(git log -1 --pretty=format:"%ad" --date=iso)
    current_commit_time=$(date -d "$current_commit_date" +%H:%M:%S)
    D=$(date -d "$next_day $current_commit_time" --iso-8601=seconds)
fi
GIT_COMMITTER_DATE="$D" git commit --amend --no-edit --date="$D" > /dev/null
echo "New commit date : $(date -d "$D" +"%c")"

git switch ${branch_name} -q
git -c advice.skippedCherryPicks=false rebase tmp-delay -q
git push origin tmp-delay:${branch_name} -q
git branch -qd tmp-delay

echo "Pushed delayed commit to remote ${branch_name} successfully"